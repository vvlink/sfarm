# 开源智慧农场项目说明


开源智慧农场（sfarm）是一个基于MQTT协议开发的，能实现数据采集和远程浇水控制的物联网种植系统。系统采用分布式设计理念，以无线的方式随时随处接入智能终端节点，部署方便，扩展性强。系统基于国产开源硬件设计，兼容创客空间中常见的电子模块，开放协议接口，支持二次开发。学生既可以利用各种数据进行科学探究，也可以自主编程，深度参与系统的功能设计。

sfarm中的“s”，指科学、简单、学校、STEM等。

- 一个和科学（Science）教育相关的（数据采集、分析）的农场；
- 一个承载中小学STEAM教育的农场；
- 一个结合智慧教育（Smart）的农场；
- 一个小型（Small ）的农场；
- 一个简易（Simple ）的农场；
- 一个为学校（School）设计的农场；
- 一个基于虚谷物联平台（SIoT）应用的农场。

sfarm的具体功能如下：

- 能够实时上传环境数据（光线、土壤湿度等）到服务器；
- 能够根据土壤湿度阈值，自行打开电磁阀浇水；
- 能够实时接受来自物联网的“浇水”指令，打开电磁阀；
- 所有的数据可以导出为Excel格式，供后期分析；
- 采用标准协议，开放编程接口，支持二次开发；
- 支持无限扩容，可以随时接入新的智能终端。

## 1.功能说明

- 能够实时上传环境数据（光线、土壤湿度等）到服务器；
- 能够根据土壤湿度阈值，自行打开电磁阀浇水；
- 能够实时接受来自物联网的“浇水”指令，打开电磁阀；
- 所有的数据可以导出为Excel格式，供后期分析；
- 采用标准协议，开放编程接口，支持二次开发；
- 支持无限扩容，可以随时接入新的智能终端。

## 2.系统搭建

### 2.1准备工作

每一个终端接入的位置，留水电接口。其中水管留4分的内牙（可接三角阀），电源则留防水插座即可。基于安全考虑，所有的水电都有独立的电源开关（建议加带漏电保护的空气开关）和水阀门（三角阀）。

提供Wi-Fi环境。如果接入的智能终端较多，需要配置企业级的无线路由器。基于安全考虑，请采用独立的Wi-Fi环境。如果需要做互联网的应用，则需要能够访问外网。

### 2.2 搭建步骤

1）配置服务器

接上拿铁熊猫的HDMI显示屏，连接Wi-Fi。运行“拿铁熊猫”的SIoT程序，记下IP地址。

注：请检查拿铁熊猫上的网络防火墙是否关闭。

2）配置智能终端

将虚谷号接上电脑（预装vvBlock），运行vvBlock，配置Wi-Fi信息，并且上传代码“aifarm_xugu_2.0.py”（需要修改SIoT服务器的IP地址和设备编号）到虚谷号，配置开机启动（在“基础配置”中）。

3）连接硬件

将扩展板、光线传感器、土壤湿度传感器、继电器、电磁阀等模块按照规范连接。其中光线传感器接A0，土壤湿度传感器接A1，继电器模块接D2。

4）系统测试

虚谷号上电（通过电源口供电），然后观察SIoT服务器的设备是否收到数据（设备名为“a0”和“a1”），然后给“d2”设备（如“af01/d2”）发送信息“1”，观察继电器模块是否闭合（或者亮起LED）。

5）打开阀门

测试正常后，电磁阀接上水管，然后打开三角阀，再次测试：

（1）检查连接处是否有漏水现象。

（2）给“d2”设备（如“af01/d2”）发送信息“1”，观察是否能够正常出水。

## 3.程序模块

开源智慧农场是一个完全开放的项目，程序都在不断增加迭代中。下面罗列的程序中，带*的为已经完成的代码。考虑到之前的学生都学过VB，部分代码用VB来编写。

### 3.1 核心软件类

1）服务器类

- SIoT管理软件*
- SIoT智慧农场插件*

2）工具类

- vvBlock
- Mind+
- mPython

### 3.2 智能终端类

- 虚谷号（xugu库）*

- pinpong（虚谷号、树莓派、迷你电脑）*

- 掌控板*

### 3.3 设备管理类

- 物联网数据观测和设备控制（所有）

  各种编程的代码，如Python、VB等。

- 物联网数据观测和设备控制（单独）*

  各种编程的代码，如Python、VB等。

- 数据监视器和设备控制器（硬件）*

  掌控板、Arduino

### 3.4 数据观察类

- 实时监控数据（订阅）*

  Python、VB

- 实时监控数据并绘图（针对某个项目的设备）*

  Python、VB

- 不同设备的数据比较

  Python、VB

### 3.5 创新应用类

- 虚实结合的花盆（Mind+）*

  将程序中的花盆和某个项目的数据“关联”，当光线、土壤湿度发生变化，花盆也会发生相应的变化，点击水壶则发送“浇水”的指令。

- 微信小程序

  运行一段代码，将某个项目的设备数据转发到EasyIoT上，并订阅EasyIoT的控制指令给设备。

- 语音管理手机端（App inventor）

  运行在安卓手机，语音控制设备进行浇水，或者查询数据。

- 数据仪表盘（Node-red）

  用Node-red制作的仪表盘页面，用Web方式呈现，显示某个设备的详细情况。

- 基于PPT文稿或者Web页面的设备创意管理*

  点击PPT文稿上的超级连接，就可以控制设备进行“浇水”。

## 4. 项目地址

GitHub地址：https://github.com/vvlink/sfarm

## 5.其他说明

### 5.1 程序说明

1）扩展名为ipynb的为Jupyter笔记文件，用虚谷号或者mPython即可打开。

2）扩展名为sb3的为Mind+文件，用Mind+打开。

3）扩展名为py的为Python文件，用Mind+或者mPython打开。

### 5.2 涉及软件清单

1）必选软件：

（1）SIoT1.3：虚谷物联项目组开发的MQTT服务器，含自主开发“智慧农场”插件。

（2）Python：编程语言

包含如下第三方库文件：

- siot：MQTT库

  - Matplotlib：绘图库

    推荐使用Mind+、mPython、Thonny之类的IDE。

1）非必选软件：

（1）vvBlock：虚谷号的编程软件

用于给虚谷号设置IP，上传程序。

（2）Jupyter：用于交互计算的Web应用程序，也称网络笔记本

用于分布演示程序，课堂教学讲解。

（3）Mind+：编程工具

用于开发物联网相关的应用软件，如数据可视化、实时控制和语音控制程序，或者虚实结合的互动媒体等。	

（4）App inventor：编程工具

用于开发语音控制的App程序。

（5）Node-red：可视化物联网编程工具

用于数据可视化和控制。

（6）VB：编程工具

### 5.3 涉及硬件清单

1）拿铁熊猫：基于Win10系统的高性能迷你电脑

运行siot，作为物联网服务器。

注：可以用任何一台电脑来担任物联网服务器。如果终端数量少，可以选择虚谷号。

2）虚谷号：基于Linux系统的开源硬件

作为智能终端，实时采集数据，控制水阀。

注：可以选择任何一款支持Wi-Fi的智能终端，如掌控板。

3）掌控板：采用国产物联网芯片的开源硬件

用于作为远程浇水控制器或者数据监视器。

4）其他硬件模块：传感器、执行器等

电磁阀、光线传感器、土壤传感器、喷头等。

### 5.4 参考资料

1）SIoT使用手册

https://siot.readthedocs.io/

2）虚谷号使用文档

https://vvboard.readthedocs.io/

